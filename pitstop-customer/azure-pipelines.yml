trigger:
  branches:
    include:
      - main

variables:
  resourceGroup: '1-87cddd74-playground-sandbox'
  location: 'southcentralus'
  acrName: '$(acrNameFromOutput)'
  imageName: 'pitstop-customer'
  imageTag: '1.0.0-$(Build.BuildId)'
  azureServiceConnection: 'connect'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: PrepareEnvironment
  displayName: 'Prepare Environment'
  jobs:
    - job: GetAcrInfo
      displayName: 'Get ACR Info'
      steps:
        - task: AzureCLI@2
          name: SetAcrInfo
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              ACR_NAME=$(az acr list --resource-group $(resourceGroup) --query "[0].name" -o tsv)
              echo "##vso[task.setvariable variable=acrNameFromOutput;isOutput=true]$ACR_NAME"
              echo "Found ACR: $ACR_NAME"

              if [ -z "$ACR_NAME" ]; then
                echo "Error: No ACR found in resource group. Exiting."
                exit 1
              fi

              ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" -o tsv)
              ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
              ACR_LOGIN_SERVER="$ACR_NAME.azurecr.io"

              echo "##vso[task.setvariable variable=acrUsername;isOutput=true]$ACR_USERNAME"
              echo "##vso[task.setvariable variable=acrPassword;isOutput=true]$ACR_PASSWORD"
              echo "##vso[task.setvariable variable=acrLoginServer;isOutput=true]$ACR_LOGIN_SERVER"

- stage: BuildAndPush
  displayName: 'Build and Push Docker Image'
  dependsOn: PrepareEnvironment
  variables:
    acrNameFromOutput: $[ stageDependencies.PrepareEnvironment.GetAcrInfo.outputs['SetAcrInfo.acrNameFromOutput'] ]
    acrUsername: $[ stageDependencies.PrepareEnvironment.GetAcrInfo.outputs['SetAcrInfo.acrUsername'] ]
    acrPassword: $[ stageDependencies.PrepareEnvironment.GetAcrInfo.outputs['SetAcrInfo.acrPassword'] ]
    acrLoginServer: $[ stageDependencies.PrepareEnvironment.GetAcrInfo.outputs['SetAcrInfo.acrLoginServer'] ]
  jobs:
    - job: BuildAndPushImage
      displayName: 'Build and Push Docker Image'
      steps:
        - task: DockerInstaller@0

        - script: |
            echo "Logging in to ACR: $(acrLoginServer)"
            echo "$(acrPassword)" | docker login $(acrLoginServer) -u $(acrUsername) --password-stdin
          displayName: 'Login to ACR'

        - script: |
            cd pitstop-customer
            docker build -t $(acrLoginServer)/$(imageName):$(imageTag) .
            docker tag $(acrLoginServer)/$(imageName):$(imageTag) $(acrLoginServer)/$(imageName):latest
            docker push $(acrLoginServer)/$(imageName):$(imageTag)
            docker push $(acrLoginServer)/$(imageName):latest
          displayName: 'Build and Push Docker Image'